# Implementation Plan: Email Token & Onboarding

**Branch**: `013-email-token-onboarding` | **Date**: 2026-01-07 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/013-email-token-onboarding/spec.md`

## Summary

Implement email-based verification token system for first-time user registration using Gmail SMTP, and post-login onboarding flow for profile data updates. The feature leverages existing email infrastructure and authentication patterns, adding a 6-digit token mechanism and onboarding screen.

## Technical Context

**Language/Version**: Python 3.11 (Backend), TypeScript 5+ (Mobile)
**Primary Dependencies**: Django 4.2+ / DRF, React Native + Expo 0.73+, React Native Paper 5+
**Storage**: PostgreSQL 14+ (existing database)
**Testing**: pytest (backend), manual testing (mobile)
**Target Platform**: iOS/Android mobile apps, Django backend server
**Project Type**: mobile + API (existing monorepo structure)
**Performance Goals**: Email delivery < 30 seconds, token validation < 1 second
**Constraints**: SMTP rate limits (Gmail: 500/day), token expiry 10 minutes
**Scale/Scope**: ~1000 beneficiaries, single email template

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. LGPD & Privacy First | ✅ PASS | Email contains only token, no PHI exposed |
| II. API-First Design | ✅ PASS | Endpoints documented in contracts/api.yaml |
| III. Healthcare Standards | ✅ N/A | No TISS/ANS impact |
| IV. Security by Design | ✅ PASS | Tokens expire, rate limited, single-use |
| V. Mobile-Accessible UX | ✅ PASS | Large token display, clear instructions |

**Constitution Compliance**: All applicable principles satisfied.

## Project Structure

### Documentation (this feature)

```text
specs/013-email-token-onboarding/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Phase 0 research findings
├── data-model.md        # Entity changes
├── quickstart.md        # Implementation guide
├── contracts/
│   └── api.yaml         # OpenAPI specification
├── checklists/
│   └── requirements.md  # Spec validation checklist
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
backend/
├── apps/
│   ├── accounts/
│   │   ├── models.py              # MODIFY: Add VerificationToken model
│   │   ├── views.py               # MODIFY: Update first-access endpoints
│   │   ├── serializers.py         # MODIFY: Include onboarding_completed
│   │   ├── urls.py                # MODIFY: Add resend endpoint
│   │   ├── utils/
│   │   │   └── email_service.py   # MODIFY: Add verification email method
│   │   └── templates/accounts/email/
│   │       └── verification_email.html  # NEW: Token email template
│   └── beneficiaries/
│       ├── models.py              # MODIFY: Add onboarding fields
│       ├── views.py               # MODIFY: Add complete-onboarding endpoint
│       └── migrations/            # NEW: Migration for onboarding fields
└── .env                           # MODIFY: Add SMTP credentials

mobile/
├── src/
│   ├── screens/
│   │   ├── Auth/
│   │   │   └── FirstAccessScreen.tsx  # MODIFY: Update for 6-digit token
│   │   └── Onboarding/
│   │       └── OnboardingScreen.tsx   # NEW: Post-login onboarding
│   ├── store/
│   │   └── slices/
│   │       └── authSlice.ts           # MODIFY: Add onboarding state
│   └── navigation/
│       └── AppNavigator.tsx           # MODIFY: Add onboarding route check
```

**Structure Decision**: Using existing monorepo structure with backend/ and mobile/ directories. Changes are incremental modifications to existing files with minimal new files.

## Complexity Tracking

> No constitution violations requiring justification.

| Component | Complexity | Rationale |
|-----------|------------|-----------|
| VerificationToken model | Low | Follows existing PasswordResetToken pattern |
| Email template | Low | Extends existing base template |
| Onboarding screen | Medium | New screen but standard patterns |
| Rate limiting | Low | Simple field-based tracking |

## Phase Summary

| Phase | Output | Status |
|-------|--------|--------|
| 0 - Research | research.md | ✅ Complete |
| 1 - Design | data-model.md, contracts/, quickstart.md | ✅ Complete |
| 2 - Tasks | tasks.md | Pending (/speckit.tasks) |

## Next Step

Run `/speckit.tasks` to generate implementation tasks from this plan.
