# Implementation Plan: Google Cloud Backend Deployment

**Branch**: `005-gcloud-backend-deploy` | **Date**: 2025-12-17 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/005-gcloud-backend-deploy/spec.md`

## Summary

Deploy the Elosaude Django backend to Google Cloud using a single Compute Engine VM with Docker. The infrastructure is defined entirely in Terraform, using patterns adapted from the api-forge-platform reference project. The deployment uses an external PostgreSQL database (already online) and serves HTTP traffic on port 8005.

## Technical Context

**Language/Version**: HCL (Terraform 1.0+), Bash (deployment scripts)
**Primary Dependencies**: Terraform, Docker, gcloud CLI, gunicorn
**Storage**: External PostgreSQL (existing), Cloud Storage (Terraform state)
**Testing**: `terraform plan` for infrastructure, curl/httpie for API health checks
**Target Platform**: Google Cloud Platform - Compute Engine (Container-Optimized OS)
**Project Type**: Infrastructure (backend deployment)
**Performance Goals**: <500ms health check response, 99% uptime
**Constraints**: ~$16/month budget, HTTP only (no SSL), single VM
**Scale/Scope**: Single Django backend, 1 VM (e2-small), external database

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. LGPD & Privacy First | PASS | No new data handling; existing security measures apply |
| II. API-First Design | PASS | No API changes; deployment only |
| III. Healthcare Standards | N/A | Infrastructure change, not healthcare logic |
| IV. Security by Design | EXCEPTION | HTTP only per user requirement; credentials via .gitignore |
| V. Mobile-Accessible UX | N/A | Backend deployment, not UI changes |

**Exception Justification**: User explicitly chose HTTP-only for initial deployment (clarification session 2025-12-17). SSL can be added via Cloud Load Balancer in a future iteration.

## Project Structure

### Documentation (this feature)

```text
specs/005-gcloud-backend-deploy/
├── plan.md              # This file
├── research.md          # Technology decisions and analysis
├── data-model.md        # Infrastructure entity definitions
├── quickstart.md        # Deployment guide
├── contracts/           # API contract for health endpoint
│   └── openapi.yaml
└── tasks.md             # Implementation tasks (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
infrastructure/
├── terraform/
│   ├── main.tf              # Main configuration
│   ├── variables.tf         # Variable definitions
│   ├── outputs.tf           # Output values
│   ├── versions.tf          # Provider versions
│   ├── terraform.tfvars.example  # Example variables (no secrets)
│   └── modules/
│       ├── compute/         # GCE VM configuration
│       │   ├── main.tf
│       │   ├── variables.tf
│       │   └── outputs.tf
│       ├── networking/      # Firewall rules
│       │   ├── main.tf
│       │   ├── variables.tf
│       │   └── outputs.tf
│       └── registry/        # Artifact Registry
│           ├── main.tf
│           ├── variables.tf
│           └── outputs.tf
└── scripts/
    ├── deploy.sh            # Full deployment script
    ├── build-push.sh        # Build and push Docker image
    └── ssh-vm.sh            # SSH into VM helper

backend/
├── Dockerfile               # Enhanced for production (gunicorn)
├── Dockerfile.prod          # Alternative: dedicated production Dockerfile
└── docker-compose.prod.yml  # Production compose configuration
```

**Structure Decision**: Simplified from reference project (api-forge-platform). Uses default VPC instead of custom networking. Three modules only: compute (GCE VM), networking (firewall rules), registry (Artifact Registry).

## Key Implementation Details

### Terraform Modules

1. **compute/**: Google Compute Engine instance
   - Container-Optimized OS for native Docker support
   - e2-small machine type (2 vCPU, 2GB RAM)
   - External IP for public access
   - Startup script to pull and run Docker container

2. **networking/**: Firewall rules
   - Allow HTTP on port 8005 from any source
   - Allow SSH on port 22 (restricted to admin IPs or IAP)
   - Allow health check traffic from GCP ranges

3. **registry/**: Google Artifact Registry
   - Docker repository for container images
   - Cleanup policy for old images

### Docker Production Configuration

```dockerfile
# Enhanced CMD for production
CMD ["gunicorn", "--bind", "0.0.0.0:8005", "--workers", "2", "--timeout", "120", "elosaude_backend.wsgi:application"]
```

### Environment Variables (VM)

```bash
DATABASE_URL=postgresql://user:pass@host:5432/dbname
DJANGO_SECRET_KEY=xxx
DJANGO_DEBUG=False
DJANGO_ALLOWED_HOSTS=*
```

## Complexity Tracking

No constitution violations requiring justification. The HTTPS exception was explicitly approved by the user during clarification.

## Dependencies

- Google Cloud project with billing enabled
- Terraform CLI 1.0+
- Docker installed locally
- gcloud CLI authenticated
- External PostgreSQL database accessible from internet
